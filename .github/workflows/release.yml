name: Release Extension

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Generate manifests from template
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"

          # Chrome manifest
          sed -e "s/{{VERSION}}/$VERSION/" \
              -e 's/{{BACKGROUND}}/{"service_worker": "background.js"}/' \
              -e 's/{{BROWSER_SPECIFIC}}//' \
              manifest.template.json > manifest.chrome.json

          # Firefox manifest
          sed -e "s/{{VERSION}}/$VERSION/" \
              -e 's/{{BACKGROUND}}/{"scripts": ["background.js"]}/' \
              -e 's/{{BROWSER_SPECIFIC}}/,\n  "browser_specific_settings": {\n    "gecko": {\n      "id": "painless-leetcode@nikaltipar",\n      "strict_min_version": "109.0"\n    }\n  }/' \
              manifest.template.json > manifest.firefox.json

      - name: Create Chrome/Edge package
        run: |
          mkdir -p dist-chrome
          cp manifest.chrome.json dist-chrome/manifest.json
          cp disable.js background.js options.html options.js popup.html popup.js LICENSE README.md dist-chrome/ 2>/dev/null || true
          cp -r icons dist-chrome/
          cd dist-chrome && zip -r ../painless-leetcode-v${{ steps.version.outputs.VERSION }}-chrome.zip .

      - name: Create Firefox package
        run: |
          mkdir -p dist-firefox
          cp manifest.firefox.json dist-firefox/manifest.json
          cp disable.js background.js options.html options.js popup.html popup.js LICENSE README.md dist-firefox/ 2>/dev/null || true
          cp -r icons dist-firefox/
          cd dist-firefox && zip -r ../painless-leetcode-v${{ steps.version.outputs.VERSION }}-firefox.zip .

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            painless-leetcode-v${{ steps.version.outputs.VERSION }}-chrome.zip
            painless-leetcode-v${{ steps.version.outputs.VERSION }}-firefox.zip
          generate_release_notes: true
          body: |
            ## ðŸ“¦ Downloads

            | Browser | Package |
            |---------|---------|
            | Chrome / Edge | `painless-leetcode-v${{ steps.version.outputs.VERSION }}-chrome.zip` |
            | Firefox | `painless-leetcode-v${{ steps.version.outputs.VERSION }}-firefox.zip` |

            See README for installation instructions.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
